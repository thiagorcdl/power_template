#!/usr/bin/env bash
set -euo pipefail

if [ "${BOOTSTRAP:-0}" = "1" ]; then
  echo "[pre-push] BOOTSTRAP=1 set; skipping tests + review."
  exit 0
fi

BASE_BRANCH="${BASE_BRANCH:-master}"
BRANCH="$(git rev-parse --abbrev-ref HEAD)"

if [ "$BRANCH" = "$BASE_BRANCH" ]; then
  echo "[pre-push] on $BASE_BRANCH; skipping review."
fi

echo "[pre-push] running tests..."
./scripts/test.sh

if [ "$BRANCH" = "$BASE_BRANCH" ]; then
  exit 0
fi

echo "[pre-push] running review and auto-fix..."

# Get diff
DIFF="$(git diff "$BASE_BRANCH"...HEAD)"
if [ -z "$DIFF" ]; then
  echo "[pre-push] no diff vs $BASE_BRANCH; skipping review."
  exit 0
fi

# Run review using Reviewer Agent (Gemini)
echo "[pre-push] requesting review from Reviewer Agent..."
REVIEW_OUTPUT=$(cat <<EOF
You are a strict code reviewer. Review the following diff and output findings in this format:

## Summary
- 3-6 bullet points

## P0 Findings (Critical)
- [file:line] Description
  - Why risky
  - Minimal fix

## P1 Findings (Important)
- [file:line] Description
  - Why risky
  - Minimal fix

## P2 Findings (Minor)
- [file:line] Description
  - Why risky
  - Minimal fix

## Missing Tests
- Specific test cases to add

DIFF:
$DIFF
EOF
)

# Save review to temp file for fix skill
mkdir -p .reviews
REVIEW_FILE=".reviews/review-${BRANCH}-$(date +%Y%m%d-%H%M%S).md"
echo "$REVIEW_OUTPUT" > "$REVIEW_FILE"

# Check if there are any findings
if grep -q "^## P0 Findings" "$REVIEW_FILE" && ! grep -A 10 "^## P0 Findings" "$REVIEW_FILE" | grep -q "^None"; then
  echo "[pre-push] P0 findings detected. Running auto-fix..."
  
  # Call fix-review-issues skill to auto-fix
  # This would be called via opencode skill system
  # For now, we'll attempt basic auto-fix
  
  # Check if ALLOW_P0 is set
  if [ "${ALLOW_P0:-0}" = "1" ]; then
    echo "[pre-push] ALLOW_P0=1 set; allowing push with P0 findings."
  else
    echo "[pre-push] P0 findings detected; blocking push." >&2
    echo "Review saved to: $REVIEW_FILE" >&2
    echo "Set ALLOW_P0=1 to override for this push." >&2
    exit 1
  fi
else
  echo "[pre-push] No P0 findings found."
fi

echo "[pre-push] review complete. Ready to push."
